<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zombie Survival Showdown</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');
  body {
    margin: 0;
    background: #202020;
    color: white;
    font-family: 'Comic Neue', cursive, Arial, sans-serif;
    user-select: none;
    overflow: hidden;
  }
  #homeScreen, #gameScreen, #shopScreen, #gameOverScreen, #winScreen {
    position: absolute;
    top:0; left:0; right:0; bottom:0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: #121212;
    z-index: 100;
  }
  #gameScreen, #shopScreen, #gameOverScreen, #winScreen {
    display: none;
  }
  h1 {
    font-size: 3.5rem;
    margin-bottom: 20px;
    text-shadow: 2px 2px #00cc00;
  }
  button {
    background: #00cc00;
    border: none;
    border-radius: 10px;
    font-size: 1.5rem;
    padding: 12px 30px;
    margin: 10px;
    color: #111;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #00ee00;
  }
  #gameCanvas {
    background: #1a1a1a;
    border: 5px solid #00cc00;
    border-radius: 20px;
    display: block;
    margin: 20px auto;
    box-shadow: 0 0 15px #00cc00aa;
    touch-action: none;
  }
  #infoBar {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-top: 5px;
    font-size: 1.3rem;
  }
  #healthBarContainer {
    width: 250px;
    height: 25px;
    border: 2px solid white;
    border-radius: 12px;
    overflow: hidden;
    background: #440000;
    margin-right: 10px;
    position: relative;
  }
  #healthBar {
    height: 100%;
    background: #00cc00;
    width: 100%;
    transition: width 0.3s;
  }
  #healthText {
    position: absolute;
    top: 0; left: 50%;
    transform: translateX(-50%);
    font-weight: bold;
    font-size: 1.1rem;
    color: white;
    user-select: none;
    pointer-events: none;
  }
  #coinsDisplay {
    font-weight: bold;
    color: #ffff55;
  }
  #waveDisplay {
    font-weight: bold;
    color: #00ffcc;
  }
  #zombiesRemaining {
    font-weight: bold;
    color: #ff6666;
  }
  #shopItems {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .shopItem {
    background: #222;
    border: 2px solid #00cc00;
    border-radius: 10px;
    margin: 10px;
    padding: 10px 15px;
    width: 180px;
    cursor: pointer;
    color: white;
    user-select: none;
    transition: background 0.3s;
  }
  .shopItem:hover {
    background: #004400;
  }
  .shopItem.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .shopItem h3 {
    margin: 5px 0;
    font-size: 1.3rem;
  }
  .shopItem p {
    margin: 3px 0;
    font-size: 1rem;
  }
  /* Invisible joystick */
  #joystickArea {
    position: absolute;
    top: 0; left: 0;
    width: 800px; height: 450px;
    z-index: 200;
    touch-action: none;
  }
  /* Attack button style */
  #attackBtn {
    position: absolute;
    bottom: 25px;
    right: 30px;
    font-size: 1.8rem;
    padding: 20px 30px;
    border-radius: 50px;
    background: #00cc00cc;
    border: none;
    color: #111;
    cursor: pointer;
    user-select: none;
    z-index: 300;
    transition: background 0.3s;
  }
  #attackBtn:hover {
    background: #00ee00cc;
  }
  /* Cheat code input */
  #cheatCodeInput {
    font-size: 1.3rem;
    padding: 8px;
    border-radius: 8px;
    border: none;
    margin-top: 15px;
    width: 180px;
    text-align: center;
  }
  #cheatCodeMsg {
    margin-top: 10px;
    font-size: 1.1rem;
    color: #00ff00;
    font-weight: bold;
    min-height: 24px;
  }
</style>
</head>
<body>

<!-- HOME SCREEN -->
<div id="homeScreen">
  <h1>Zombie Survival Showdown</h1>
  <button id="startBtn">Start Fighting</button>
  <p style="margin-top: 20px; font-size: 1.2rem;">Survive 25 waves of zombies! üßü‚Äç‚ôÇÔ∏èüßüüßü‚Äç‚ôÄÔ∏è</p>
  <input id="cheatCodeInput" type="text" placeholder="Enter cheat code here" maxlength="5" />
  <div id="cheatCodeMsg"></div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" style="position: relative;">
  <canvas id="gameCanvas" width="800" height="450"></canvas>

  <!-- Invisible joystick -->
  <div id="joystickArea"></div>

  <!-- Attack button -->
  <button id="attackBtn">Attack üî™</button>

  <div id="infoBar">
    <div style="display:flex; align-items:center;">
      <div id="healthBarContainer">
        <div id="healthBar"></div>
        <div id="healthText">100 / 100</div>
      </div>
      <div>Health</div>
    </div>
    <div id="coinsDisplay">Coins: 0 üí∞</div>
    <div id="waveDisplay">Wave: 1/25</div>
    <div id="zombiesRemaining">Zombies: 0</div>
  </div>
</div>

<!-- SHOP SCREEN -->
<div id="shopScreen">
  <h1>Shop - Upgrade Your Arsenal</h1>
  <div id="coinsDisplayShop" style="font-size:1.5rem; color: #ffff55;"></div>
  <div id="shopItems"></div>
  <button id="continueBtn" style="margin-top: 25px;">Continue to Next Wave</button>
</div>

<!-- GAME OVER SCREEN -->
<div id="gameOverScreen">
  <h1>Game Over</h1>
  <p id="gameOverText" style="font-size: 1.8rem; margin: 20px;"></p>
  <button id="restartBtn">Restart</button>
</div>

<!-- WIN SCREEN -->
<div id="winScreen">
  <h1>Congratulations!</h1>
  <p style="font-size: 1.8rem; margin: 20px;">You survived all 25 waves! üßü‚Äç‚ôÇÔ∏èüí•üôé‚Äç‚ôÇÔ∏è</p>
  <button id="winRestartBtn">Play Again</button>
</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  // DOM elements
  const homeScreen = document.getElementById('homeScreen');
  const gameScreen = document.getElementById('gameScreen');
  const shopScreen = document.getElementById('shopScreen');
  const gameOverScreen = document.getElementById('gameOverScreen');
  const winScreen = document.getElementById('winScreen');

  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const winRestartBtn = document.getElementById('winRestartBtn');

  const continueBtn = document.getElementById('continueBtn');

  const healthBar = document.getElementById('healthBar');
  const healthText = document.getElementById('healthText');
  const coinsDisplay = document.getElementById('coinsDisplay');
  const coinsDisplayShop = document.getElementById('coinsDisplayShop');
  const waveDisplay = document.getElementById('waveDisplay');
  const zombiesRemaining = document.getElementById('zombiesRemaining');
  const gameOverText = document.getElementById('gameOverText');
  const shopItemsContainer = document.getElementById('shopItems');

  const joystickArea = document.getElementById('joystickArea');
  const attackBtn = document.getElementById('attackBtn');

  const cheatCodeInput = document.getElementById('cheatCodeInput');
  const cheatCodeMsg = document.getElementById('cheatCodeMsg');

  // Sounds
  const sounds = {
    knife: new Audio('https://actions.google.com/sounds/v1/weapons/knife_stab.ogg'),
    pistol: new Audio('https://actions.google.com/sounds/v1/weapons/pistol_shot.ogg'),
    rifle: new Audio('https://actions.google.com/sounds/v1/weapons/automatic_rifle.ogg'),
    shotgun: new Audio('https://actions.google.com/sounds/v1/weapons/shotgun_fire.ogg'),
    rocket: new Audio('https://actions.google.com/sounds/v1/explosions/explosion_large.ogg'),
    hit: new Audio('https://actions.google.com/sounds/v1/human_voices/gasp.ogg'),
    zombieGrowl: new Audio('https://actions.google.com/sounds/v1/creatures/zombie_growl_1.ogg'),
    gameOver: new Audio('https://actions.google.com/sounds/v1/cartoon/slide_whistle_down.ogg'),
    win: new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'),
  };
  for(let s in sounds) sounds[s].volume = 0.15;

  // Game constants & variables
  const PLAYER_START_HEALTH = 100;
  const WAVE_TOTAL = 25;
  const SHOP_TIME = 10 * 1000;
  const ZOMBIE_DAMAGE = 0.5;

  const weapons = [
    {
      name: "Knife",
      cost: 0,
      damage: 10,
      emoji: "üî™",
      sfx: sounds.knife,
      desc: "Basic melee weapon, infinite uses",
      unlocked: true,
      isHealItem: false,
      healAmount: 0,
      rangeMultiplier: 1,
      maxTargets: 1,
    },
    {
      name: "Pistol",
      cost: 50,
      damage: 15,
      emoji: "üî´",
      sfx: sounds.pistol,
      desc: "Basic handgun, better range",
      unlocked: false,
      isHealItem: false,
      healAmount: 0,
      rangeMultiplier: 1.5,
      maxTargets: 1,
    },
    {
      name: "Rifle",
      cost: 150,
      damage: 25,
      emoji: "üî´üî´",
      sfx: sounds.rifle,
      desc: "Powerful automatic rifle",
      unlocked: false,
      isHealItem: false,
      healAmount: 0,
      rangeMultiplier: 2,
      maxTargets: 1,
    },
    {
      name: "Shotgun",
      cost: 400,
      damage: 50,
      emoji: "üî´üî´üî´",
      sfx: sounds.shotgun,
      desc: "Close range but heavy damage, can hit 3 zombies at once",
      unlocked: false,
      isHealItem: false,
      healAmount: 0,
      rangeMultiplier: 1.5,
      maxTargets: 3,
    },
    {
      name: "Rocket Launcher",
      cost: 750,
      damage: 100,
      emoji: "üöÄ",
      sfx: sounds.rocket,
      desc: "Explodes up to 15 zombies at once",
      unlocked: false,
      isHealItem: false,
      healAmount: 0,
      rangeMultiplier: 5,
      maxTargets: 15,
    },
    {
      name: "Apple",
      cost: 25,
      damage: 0,
      emoji: "üçé",
      sfx: null,
      desc: "Restores 25 health",
      unlocked: true,
      isHealItem: true,
      healAmount: 25,
      rangeMultiplier: 0,
      maxTargets: 0,
    },
    {
      name: "Full Heal Device",
      cost: 100,
      damage: 0,
      emoji: "üíä",
      sfx: null,
      desc: "Fully restores health",
      unlocked: true,
      isHealItem: true,
      healAmount: 100,
      rangeMultiplier: 0,
      maxTargets: 0,
    }
  ];

  let player = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    width: 35,
    height: 50,
    health: PLAYER_START_HEALTH,
    coins: 0,
    weaponIndex: 0,
    speed: 1.4,
    facing: 'right',
    lastHitTimes: new Map(), // to track zombie hit cooldowns
  };

  let zombies = [];
  let wave = 0;
  let gameRunning = false;
  let inShop = false;
  let keysPressed = {};
  let lastAttackTime = 0;
  let cheatCoinsActive = false;

  // Joystick vars
  let joystickActive = false;
  let joystickStartX = 0;
  let joystickStartY = 0;
  let joystickCurrentX = 0;
  let joystickCurrentY = 0;

  // Helper functions
  function playSfx(sound) {
    if (!sound) return;
    sound.currentTime = 0;
    sound.play();
  }

  function rectCollide(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw &&
           ax + aw > bx &&
           ay < by + bh &&
           ah + ay > by;
  }

  // Prevent zombies piling: simple collision avoidance
  function avoidZombiePile() {
    for (let i = 0; i < zombies.length; i++) {
      let z1 = zombies[i];
      if (!z1.alive) continue;
      for (let j = i + 1; j < zombies.length; j++) {
        let z2 = zombies[j];
        if (!z2.alive) continue;
        let dx = z2.x - z1.x;
        let dy = z2.y - z1.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        let minDist = 40; // minimum separation distance
        if (dist < minDist && dist > 0) {
          let overlap = minDist - dist;
          let pushX = (dx / dist) * (overlap / 2);
          let pushY = (dy / dist) * (overlap / 2);
          z1.x -= pushX;
          z1.y -= pushY;
          z2.x += pushX;
          z2.y += pushY;
          // Clamp inside canvas
          z1.x = Math.min(canvas.width-20, Math.max(20, z1.x));
          z1.y = Math.min(canvas.height-60, Math.max(60, z1.y));
          z2.x = Math.min(canvas.width-20, Math.max(20, z2.x));
          z2.y = Math.min(canvas.height-60, Math.max(60, z2.y));
        }
      }
    }
  }

  function spawnZombies(waveNum) {
    zombies = [];
    const baseCount = Math.min(5 + waveNum * 2, 60);
    const baseHealth = 50;
    const baseSpeed = 0.7 + waveNum * 0.05;

    for(let i=0; i<baseCount; i++) {
      let side = Math.random() < 0.5 ? 'left' : 'right';
      zombies.push({
        id: i,
        x: side === 'left' ? -30 - Math.random() * 300 : canvas.width + 30 + Math.random() * 300,
        y: canvas.height - 70 - (Math.random() * 50),
        width: 40,
        height: 60,
        health: baseHealth,
        maxHealth: baseHealth,
        speed: baseSpeed + Math.random() * 0.4,
        side: side,
        emoji: ["üßü","üßü‚Äç‚ôÄÔ∏è","üßü‚Äç‚ôÇÔ∏è"][Math.floor(Math.random()*3)],
        alive: true,
        lastHitTime: 0,
      });
    }
  }

  function resetPlayer() {
    player.health = PLAYER_START_HEALTH;
    if (!cheatCoinsActive) player.coins = 0;
    player.weaponIndex = 0;
    player.x = canvas.width / 2;
    player.y = canvas.height / 2;
    player.facing = 'right';
  }

  function showScreen(screen) {
    [homeScreen, gameScreen, shopScreen, gameOverScreen, winScreen].forEach(s => {
      s.style.display = 'none';
    });
    screen.style.display = 'flex';
  }

  function drawPlayer() {
    ctx.font = '50px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    let emoji = "üôÇ"; // default player emoji
    if (player.health <= 20) emoji = "üòµ";
    else if (player.health <= 50) emoji = "üòü";
    ctx.fillText(emoji, player.x, player.y + 20);
  }

  function drawZombies() {
    zombies.forEach(z => {
      if (!z.alive) return;
      ctx.font = '50px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.fillText(z.emoji, z.x, z.y + 20);

      // Draw health bar above zombie
      const barWidth = 40;
      const barHeight = 6;
      const healthPct = z.health / z.maxHealth;
      ctx.fillStyle = '#440000';
      ctx.fillRect(z.x - barWidth/2, z.y - 20, barWidth, barHeight);
      ctx.fillStyle = '#ff4444';
      ctx.fillRect(z.x - barWidth/2, z.y - 20, barWidth * healthPct, barHeight);
      ctx.strokeStyle = 'black';
      ctx.strokeRect(z.x - barWidth/2, z.y - 20, barWidth, barHeight);
    });
  }

  function updateHealthBar() {
    healthBar.style.width = Math.max(0, (player.health / PLAYER_START_HEALTH) * 100) + '%';
    healthText.textContent = `${Math.max(0, Math.floor(player.health))} / ${PLAYER_START_HEALTH}`;
  }
  function updateCoins() {
    coinsDisplay.textContent = `Coins: ${player.coins} üí∞`;
    coinsDisplayShop.textContent = `Coins: ${player.coins} üí∞`;
  }
  function updateWave() {
    waveDisplay.textContent = `Wave: ${wave}/${WAVE_TOTAL}`;
  }
  function updateZombiesRemaining() {
    const aliveCount = zombies.filter(z => z.alive).length;
    zombiesRemaining.textContent = `Zombies: ${aliveCount}`;
  }

  function movePlayer(dx, dy) {
    player.x += dx;
    player.y += dy;
    player.x = Math.min(canvas.width - player.width/2, Math.max(player.width/2, player.x));
    player.y = Math.min(canvas.height - player.height/2, Math.max(player.height/2, player.y));
  }

  function handleMovement() {
    if(!joystickActive) return;
    const dx = joystickCurrentX - joystickStartX;
    const dy = joystickCurrentY - joystickStartY;
    const maxDist = 50;
    let dist = Math.sqrt(dx*dx + dy*dy);
    if(dist > maxDist) dist = maxDist;
    const normX = dx / dist || 0;
    const normY = dy / dist || 0;
    const speed = player.speed * (dist / maxDist);
    movePlayer(normX * speed, normY * speed);
    if (dx > 0) player.facing = 'right';
    else if(dx < 0) player.facing = 'left';
  }

  function zombiesMoveTowardsPlayer() {
    zombies.forEach(z => {
      if(!z.alive) return;
      let dx = player.x - z.x;
      let dy = player.y - z.y;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < 2) dist = 2; // avoid division by zero
      z.x += (dx / dist) * z.speed;
      z.y += (dy / dist) * z.speed;
    });
  }

  function zombiesAttackPlayer() {
    zombies.forEach(z => {
      if(!z.alive) return;
      const dist = Math.hypot(player.x - z.x, player.y - z.y);
      if(dist < 40) {
        player.health -= ZOMBIE_DAMAGE;
        if (player.health < 0) player.health = 0;
        updateHealthBar();
        playSfx(sounds.hit);
      }
    });
  }

  // Calculate coin reward based on wave and kills
  function getCoinsPerKill() {
    if (wave <= 4) return randomInt(1, 5);
    if (wave <= 9) return randomInt(6, 10);
    if (wave <= 15) return randomInt(11, 35);
    if (wave <= 20) return randomInt(36, 40);
    return randomInt(45, 50);
  }

  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function attack() {
    const now = Date.now();
    if (now - lastAttackTime < 500) return; // half-second cooldown
    lastAttackTime = now;

    const weapon = weapons[player.weaponIndex];
    playSfx(weapon.sfx);

    // Find zombies in range
    const range = 50 * weapon.rangeMultiplier;
    const maxTargets = weapon.maxTargets;
    const targetsHit = [];

    zombies.forEach(z => {
      if(!z.alive) return;
      const dist = Math.hypot(player.x - z.x, player.y - z.y);
      if(dist <= range && targetsHit.length < maxTargets) {
        z.health -= weapon.damage;
        z.health = Math.max(0, z.health);
        targetsHit.push(z);
        if(z.health <= 0) {
          z.alive = false;
          player.coins += getCoinsPerKill();
          updateCoins();
        }
      }
    });

    updateZombiesRemaining();
  }

  // SHOP
  function showShop() {
    inShop = true;
    showScreen(shopScreen);
    updateCoins();

    shopItemsContainer.innerHTML = '';

    weapons.forEach((w, i) => {
      if(i === 0 && !w.isHealItem) return; // skip knife purchase

      const itemDiv = document.createElement('div');
      itemDiv.classList.add('shopItem');

      const affordable = player.coins >= w.cost;
      const canBuyWeapon = !w.isHealItem && !w.unlocked;
      const canBuyHealItem = w.isHealItem;

      if(!affordable || (!canBuyWeapon && !canBuyHealItem)) {
        itemDiv.classList.add('disabled');
      }

      itemDiv.innerHTML = `<h3>${w.name} ${w.emoji}</h3>
      <p>${w.desc}</p>
      <p>Cost: ${w.cost} coins</p>`;

      itemDiv.addEventListener('click', () => {
        if(player.coins >= w.cost && (canBuyHealItem || canBuyWeapon)) {
          player.coins -= w.cost;

          if(w.isHealItem) {
            player.health += w.healAmount;
            if(player.health > PLAYER_START_HEALTH) player.health = PLAYER_START_HEALTH;
          } else {
            w.unlocked = true;
            player.weaponIndex = i; // auto equip weapon
          }
          updateCoins();
          updateHealthBar();
          showShop(); // refresh shop display
        }
      });

      shopItemsContainer.appendChild(itemDiv);
    });
  }

  // GAME LOOP
  function gameLoop() {
    if(!gameRunning) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    handleMovement();
    zombiesMoveTowardsPlayer();
    avoidZombiePile();
    zombiesAttackPlayer();

    if(player.health <= 0) {
      gameOver();
      return;
    }

    drawPlayer();
    drawZombies();

    updateHealthBar();
    updateCoins();
    updateWave();
    updateZombiesRemaining();

    // Win condition
    if(wave > WAVE_TOTAL) {
      gameWin();
      return;
    }

    // Wave complete condition
    if(zombies.every(z => !z.alive)) {
      gameRunning = false;
      showShop();
    }

    requestAnimationFrame(gameLoop);
  }

  function gameOver() {
    gameRunning = false;
    showScreen(gameOverScreen);
    gameOverText.textContent = `You died on wave ${wave}. Coins earned: ${player.coins}`;
    playSfx(sounds.gameOver);
    cheatCoinsActive = false;
  }

  function gameWin() {
    gameRunning = false;
    showScreen(winScreen);
    playSfx(sounds.win);
  }

  // Input handlers
  startBtn.onclick = () => {
    wave = 1;
    resetPlayer();
    spawnZombies(wave);
    showScreen(gameScreen);
    gameRunning = true;
    inShop = false;
    updateHealthBar();
    updateCoins();
    updateWave();
    updateZombiesRemaining();
    cheatCodeMsg.textContent = '';
    cheatCodeInput.value = '';
    requestAnimationFrame(gameLoop);
  };

  restartBtn.onclick = () => {
    showScreen(homeScreen);
  };
  winRestartBtn.onclick = () => {
    showScreen(homeScreen);
  };

  continueBtn.onclick = () => {
    wave++;
    if(wave > WAVE_TOTAL) {
      gameWin();
      return;
    }
    spawnZombies(wave);
    showScreen(gameScreen);
    gameRunning = true;
    inShop = false;
    updateWave();
    updateZombiesRemaining();
    requestAnimationFrame(gameLoop);
  };

  // Cheat code logic
  cheatCodeInput.addEventListener('input', () => {
    const val = cheatCodeInput.value.trim();
    if(val.length === 5) {
      if(val === "77660") {
        player.coins += 100000;
        cheatCoinsActive = true;
        cheatCodeMsg.textContent = "Cheat code accepted! +100,000 coins";
        updateCoins();
      } else if(val === "50988") {
        player.coins += 100000;
        cheatCoinsActive = true;
        wave = 24;
        spawnZombies(wave);
        // Unlock and equip rocket launcher
        weapons[4].unlocked = true;
        player.weaponIndex = 4;
        cheatCodeMsg.textContent = "Cheat code accepted! +100,000 coins, wave 24, rocket launcher equipped!";
        updateCoins();
        updateWave();
        updateZombiesRemaining();
      } else {
        cheatCodeMsg.textContent = "Invalid cheat code!";
      }
      cheatCodeInput.value = '';
    }
  });

  // Joystick support for movement on mobile & desktop
  joystickArea.addEventListener('pointerdown', e => {
    joystickActive = true;
    joystickStartX = e.clientX;
    joystickStartY = e.clientY;
    joystickCurrentX = e.clientX;
    joystickCurrentY = e.clientY;
  });
  joystickArea.addEventListener('pointermove', e => {
    if(!joystickActive) return;
    joystickCurrentX = e.clientX;
    joystickCurrentY = e.clientY;
  });
  joystickArea.addEventListener('pointerup', e => {
    joystickActive = false;
  });
  joystickArea.addEventListener('pointercancel', e => {
    joystickActive = false;
  });
  joystickArea.addEventListener('pointerleave', e => {
    joystickActive = false;
  });

  // Keyboard fallback movement (for desktop testing)
  window.addEventListener('keydown', e => {
    keysPressed[e.key.toLowerCase()] = true;
  });
  window.addEventListener('keyup', e => {
    keysPressed[e.key.toLowerCase()] = false;
  });

  // Attack button click
  attackBtn.addEventListener('click', attack);

  // Keyboard attack with spacebar
  window.addEventListener('keydown', e => {
    if(e.key === ' ' && gameRunning && !inShop) {
      e.preventDefault();
      attack();
    }
  });

  // Keyboard WASD movement support for desktop testing
  function handleKeys() {
    if(!joystickActive && gameRunning && !inShop) {
      let dx = 0, dy = 0;
      if(keysPressed['w'] || keysPressed['arrowup']) dy -= player.speed;
      if(keysPressed['s'] || keysPressed['arrowdown']) dy += player.speed;
      if(keysPressed['a'] || keysPressed['arrowleft']) dx -= player.speed;
      if(keysPressed['d'] || keysPressed['arrowright']) dx += player.speed;
      if(dx !== 0 || dy !== 0) {
        movePlayer(dx, dy);
        if(dx > 0) player.facing = 'right';
        else if(dx < 0) player.facing = 'left';
      }
    }
  }

  function mainLoop() {
    handleKeys();
    requestAnimationFrame(mainLoop);
  }
  mainLoop();

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>2D Golf with Home Screen & Mobile Drag Fix</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      user-select: none;
      background: #90ee90;
    }
    canvas {
      display: block;
      border: 5px solid black;
      margin: auto;
      touch-action: none;
      background: #87CEEB; /* default sunshine valley bg */
    }
    #homeScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 4px solid #333;
      padding: 20px 40px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      user-select: none;
      width: 300px;
    }
    #homeScreen h1 {
      margin-bottom: 10px;
      font-size: 2.5em;
      color: #2a7f62;
      text-shadow: 1px 1px 0 #a3f0b1;
    }
    #homeScreen h2 {
      margin: 10px 0 20px 0;
      font-weight: normal;
      color: #444;
    }
    button {
      font-size: 1.2em;
      margin: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: #2a7f62;
      color: white;
      box-shadow: 0 4px #1f5a44;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #3bb87f;
    }
    #highScoreText {
      margin-top: 15px;
      font-size: 1.1em;
      color: #666;
    }
  </style>
</head>
<body>

<div id="homeScreen">
  <h1>2D Golf!</h1>
  <h2 id="courseName">Sunshine Valley - 9 Holes</h2>
  <button id="startBtn">Start Game</button>
  <div>
    <button id="courseSunshine">Sunshine Valley</button>
    <button id="courseMoonlight">Moonlight Valley</button>
  </div>
  <div id="highScoreText"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const homeScreen = document.getElementById("homeScreen");
const startBtn = document.getElementById("startBtn");
const courseSunshineBtn = document.getElementById("courseSunshine");
const courseMoonlightBtn = document.getElementById("courseMoonlight");
const courseNameText = document.getElementById("courseName");
const highScoreText = document.getElementById("highScoreText");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let courses = {
  sunshine: {
    name: "Sunshine Valley - 9 Holes",
    background: "#87CEEB",
    levels: [
      { start: { x: 100, y: canvas.height - 120 }, hole: { x: canvas.width - 120, y: 100 }, par: 3,
        obstacles: [{ x: canvas.width/2 - 50, y: canvas.height/2, width: 40, height: 80, type: "tree" }],
        sandPits: [{ x: canvas.width/2 - 100, y: canvas.height/2 + 150, radius: 60 }] },
      { start: { x: 120, y: canvas.height - 150 }, hole: { x: canvas.width - 150, y: 130 }, par: 4,
        obstacles: [{ x: canvas.width/2, y: canvas.height/2 + 20, width: 100, height: 40, type: "log" }],
        sandPits: [{ x: canvas.width/2 + 50, y: canvas.height/2 + 180, radius: 50 }] },
      { start: { x: 90, y: canvas.height - 130 }, hole: { x: canvas.width - 130, y: 140 }, par: 3,
        obstacles: [
          { x: canvas.width/2 - 80, y: canvas.height/2 + 50, width: 40, height: 80, type: "tree" },
          { x: canvas.width/2 + 70, y: canvas.height/2 + 80, width: 100, height: 40, type: "log" }
        ],
        sandPits: [{ x: canvas.width/2, y: canvas.height/2 + 160, radius: 70 }] },
      { start: { x: 110, y: canvas.height - 110 }, hole: { x: canvas.width - 140, y: 110 }, par: 4,
        obstacles: [{ x: canvas.width/2 - 40, y: canvas.height/2 + 60, width: 80, height: 40, type: "log" }],
        sandPits: [{ x: canvas.width/2 + 30, y: canvas.height/2 + 170, radius: 55 }] },
      { start: { x: 80, y: canvas.height - 120 }, hole: { x: canvas.width - 160, y: 100 }, par: 3,
        obstacles: [{ x: canvas.width/2, y: canvas.height/2 + 40, width: 50, height: 90, type: "tree" }],
        sandPits: [{ x: canvas.width/2 + 60, y: canvas.height/2 + 140, radius: 60 }] },
      { start: { x: 120, y: canvas.height - 140 }, hole: { x: canvas.width - 150, y: 120 }, par: 5,
        obstacles: [
          { x: canvas.width/2 - 70, y: canvas.height/2 + 50, width: 40, height: 80, type: "tree" },
          { x: canvas.width/2 + 60, y: canvas.height/2 + 90, width: 110, height: 40, type: "log" }
        ],
        sandPits: [{ x: canvas.width/2 + 20, y: canvas.height/2 + 170, radius: 70 }] },
      { start: { x: 90, y: canvas.height - 130 }, hole: { x: canvas.width - 130, y: 150 }, par: 4,
        obstacles: [{ x: canvas.width/2 - 40, y: canvas.height/2 + 70, width: 90, height: 40, type: "log" }],
        sandPits: [{ x: canvas.width/2 + 50, y: canvas.height/2 + 180, radius: 60 }] },
      { start: { x: 110, y: canvas.height - 110 }, hole: { x: canvas.width - 140, y: 140 }, par: 3,
        obstacles: [{ x: canvas.width/2, y: canvas.height/2 + 60, width: 40, height: 90, type: "tree" }],
        sandPits: [{ x: canvas.width/2 + 40, y: canvas.height/2 + 160, radius: 65 }] },
      { start: { x: 100, y: canvas.height - 120 }, hole: { x: canvas.width - 130, y: 130 }, par: 5,
        obstacles: [
          { x: canvas.width/2 - 60, y: canvas.height/2 + 50, width: 40, height: 80, type: "tree" },
          { x: canvas.width/2 + 70, y: canvas.height/2 + 80, width: 110, height: 40, type: "log" }
        ],
        sandPits: [{ x: canvas.width/2 + 20, y: canvas.height/2 + 170, radius: 70 }] }
    ]
  },
  moonlight: {
    name: "Moonlight Valley - 9 Holes",
    background: "#0a0a0a",
    levels: [
      { start: { x: 100, y: canvas.height - 120 }, hole: { x: canvas.width - 120, y: 100 }, par: 3,
        obstacles: [{ x: canvas.width/2 - 50, y: canvas.height/2, width: 40, height: 80, type: "tree" }],
        sandPits: [{ x: canvas.width/2 - 100, y: canvas.height/2 + 150, radius: 60 }] },
      { start: { x: 120, y: canvas.height - 150 }, hole: { x: canvas.width - 150, y: 130 }, par: 4,
        obstacles: [{ x: canvas.width/2, y: canvas.height/2 + 20, width: 100, height: 40, type: "log" }],
        sandPits: [{ x: canvas.width/2 + 50, y: canvas.height/2 + 180, radius: 50 }] },
      { start: { x: 90, y: canvas.height - 130 }, hole: { x: canvas.width - 130, y: 140 }, par: 3,
        obstacles: [
          { x: canvas.width/2 - 80, y: canvas.height/2 + 50, width: 40, height: 80, type: "tree" },
          { x: canvas.width/2 + 70, y: canvas.height/2 + 80, width: 100, height: 40, type: "log" }
        ],
        sandPits: [{ x: canvas.width/2, y: canvas.height/2 + 160, radius: 70 }] },
      { start: { x: 110, y: canvas.height - 110 }, hole: { x: canvas.width - 140, y: 110 }, par: 4,
        obstacles: [{ x: canvas.width/2 - 40, y: canvas.height/2 + 60, width: 80, height: 40, type: "log" }],
        sandPits: [{ x: canvas.width/2 + 30, y: canvas.height/2 + 170, radius: 55 }] },
      { start: { x: 80, y: canvas.height - 120 }, hole: { x: canvas.width - 160, y: 100 }, par: 3,
        obstacles: [{ x: canvas.width/2, y: canvas.height/2 + 40, width: 50, height: 90, type: "tree" }],
        sandPits: [{ x: canvas.width/2 + 60, y: canvas.height/2 + 140, radius: 60 }] },
      { start: { x: 120, y: canvas.height - 140 }, hole: { x: canvas.width - 150, y: 120 }, par: 5,
        obstacles: [
          { x: canvas.width/2 - 70, y: canvas.height/2 + 50, width: 40, height: 80, type: "tree" },
          { x: canvas.width/2 + 60, y: canvas.height/2 + 90, width: 110, height: 40, type: "log" }
        ],
        sandPits: [{ x: canvas.width/2 + 20, y: canvas.height/2 + 170, radius: 70 }] },
      { start: { x: 90, y: canvas.height - 130 }, hole: { x: canvas.width - 130, y: 150 }, par: 4,
        obstacles: [{ x: canvas.width/2 - 40, y: canvas.height/2 + 70, width: 90, height: 40, type: "log" }],
        sandPits: [{ x: canvas.width/2 + 50, y: canvas.height/2 + 180, radius: 60 }] },
      { start: { x: 110, y: canvas.height - 110 }, hole: { x: canvas.width - 140, y: 140 }, par: 3,
        obstacles: [{ x: canvas.width/2, y: canvas.height/2 + 60, width: 40, height: 90, type: "tree" }],
        sandPits: [{ x: canvas.width/2 + 40, y: canvas.height/2 + 160, radius: 65 }] },
      { start: { x: 100, y: canvas.height - 120 }, hole: { x: canvas.width - 130, y: 130 }, par: 5,
        obstacles: [
          { x: canvas.width/2 - 60, y: canvas.height/2 + 50, width: 40, height: 80, type: "tree" },
          { x: canvas.width/2 + 70, y: canvas.height/2 + 80, width: 110, height: 40, type: "log" }
        ],
        sandPits: [{ x: canvas.width/2 + 20, y: canvas.height/2 + 170, radius: 70 }] }
    ]
  }
};

let selectedCourse = "sunshine";
let level = 0;
let strokes = 0;
let totalStrokes = [];
let ball = {
  x: 0,
  y: 0,
  radius: 15,
  vx: 0,
  vy: 0,
  isMoving: false
};

const friction = 0.98;
const powerScale = 0.2;
const bounceLoss = 0.7;
const maxSwishPower = 25;
let isDragging = false;
let dragStart = { x: 0, y: 0 };
let dragEnd = { x: 0, y: 0 };
let currentPower = 0;

function loadLevel(n) {
  const lvl = courses[selectedCourse].levels[n];
  ball.x = lvl.start.x;
  ball.y = lvl.start.y;
  ball.vx = 0;
  ball.vy = 0;
  ball.isMoving = false;
  strokes = 0;
  updateBackground();
}
function updateBackground() {
  canvas.style.background = courses[selectedCourse].background;
}

function updateHighScoreDisplay() {
  const key = `golf_highscore_${selectedCourse}`;
  const hs = localStorage.getItem(key);
  if (hs) {
    highScoreText.textContent = `Best Score: ${hs} strokes`;
  } else {
    highScoreText.textContent = `No high score yet. Be the first!`;
  }
}

function drawBall() {
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
  ctx.fillStyle = selectedCourse === "moonlight" ? "#eee" : "#fff";
  ctx.fill();
  ctx.strokeStyle = "#000";
  ctx.stroke();
}

function drawHole() {
  const hole = courses[selectedCourse].levels[level].hole;
  ctx.beginPath();
  ctx.arc(hole.x, hole.y, 20, 0, Math.PI * 2);
  ctx.fillStyle = selectedCourse === "moonlight" ? "#bbb" : "black";
  ctx.fill();
}

function drawObstacles() {
  for (let obs of courses[selectedCourse].levels[level].obstacles) {
    ctx.fillStyle = obs.type === "tree" ? "#228B22" : "#8B4513";
    ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
  }
}

function drawSand() {
  for (let sand of courses[selectedCourse].levels[level].sandPits) {
    ctx.beginPath();
    ctx.arc(sand.x, sand.y, sand.radius, 0, Math.PI * 2);
    ctx.fillStyle = "#F4A460";
    ctx.fill();
  }
}

function drawLineAndPower() {
  if (isDragging) {
    ctx.beginPath();
    ctx.moveTo(ball.x, ball.y);
    ctx.lineTo(dragEnd.x, dragEnd.y);
    ctx.strokeStyle = "red";
    ctx.stroke();

    const dx = dragStart.x - dragEnd.x;
    const dy = dragStart.y - dragEnd.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    currentPower = Math.min(Math.floor(dist / 3), 100);

    ctx.fillStyle = selectedCourse === "moonlight" ? "#eee" : "black";
    ctx.font = "20px Arial";
    ctx.fillText("Power: " + currentPower + "%", 20, 40);
  }

  ctx.fillStyle = selectedCourse === "moonlight" ? "#eee" : "black";
  ctx.font = "20px Arial";
  ctx.fillText(`Hole ${level + 1} | Strokes: ${strokes} | Par: ${courses[selectedCourse].levels[level].par}`, 20, 70);
}

function updateBall() {
  if (ball.isMoving) {
    ball.x += ball.vx;
    ball.y += ball.vy;

    for (let sand of courses[selectedCourse].levels[level].sandPits) {
      const dx = ball.x - sand.x;
      const dy = ball.y - sand.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < sand.radius) {
        ball.vx *= 0.95;
        ball.vy *= 0.95;
      }
    }

    if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) {
      ball.vx *= -bounceLoss;
      ball.x = Math.max(ball.radius, Math.min(ball.x, canvas.width - ball.radius));
    }
    if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
      ball.vy *= -bounceLoss;
      ball.y = Math.max(ball.radius, Math.min(ball.y, canvas.height - ball.radius));
    }

    for (let obs of courses[selectedCourse].levels[level].obstacles) {
      if (
        ball.x + ball.radius > obs.x &&
        ball.x - ball.radius < obs.x + obs.width &&
        ball.y + ball.radius > obs.y &&
        ball.y - ball.radius < obs.y + obs.height
      ) {
        ball.vx *= -bounceLoss;
        ball.vy *= -bounceLoss;
      }
    }

    ball.vx *= friction;
    ball.vy *= friction;

    if (Math.abs(ball.vx) < 0.1 && Math.abs(ball.vy) < 0.1) {
      ball.vx = 0;
      ball.vy = 0;
      ball.isMoving = false;
    }
  }
}

function checkHole() {
  const hole = courses[selectedCourse].levels[level].hole;
  const dx = ball.x - hole.x;
  const dy = ball.y - hole.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  const speed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy);
  const powerPercent = (speed / (100 * powerScale)) * 100;

  if (dist < 20) {
    if (powerPercent <= maxSwishPower) {
      totalStrokes.push(strokes);
      level++;
      if (level >= courses[selectedCourse].levels.length) {
        showScorecard();
      } else {
        loadLevel(level);
      }
    } else {
      // Bounce out of hole if too powerful
      const angle = Math.atan2(dy, dx);
      ball.vx = Math.cos(angle) * speed * 0.6;
      ball.vy = Math.sin(angle) * speed * 0.6;
    }
  }
}

function showScorecard() {
  let totalScore = totalStrokes.reduce((a,b)=>a+b,0);
  let msg = `🏌️ Scorecard for ${courses[selectedCourse].name}:\n\n`;
  for (let i = 0; i < courses[selectedCourse].levels.length; i++) {
    const diff = totalStrokes[i] - courses[selectedCourse].levels[i].par;
    const result = diff === 0 ? "Par" : diff > 0 ? "+" + diff : diff;
    msg += `Hole ${i + 1}: ${totalStrokes[i]} strokes (${result})\n`;
  }
  msg += `\nTotal strokes: ${totalScore}`;
  alert(msg);

  // Update high score in localStorage (lowest strokes)
  const key = `golf_highscore_${selectedCourse}`;
  const storedHighScore = localStorage.getItem(key);
  if (!storedHighScore || totalScore < storedHighScore) {
    localStorage.setItem(key, totalScore);
    alert("New Best Score! 🎉");
  }

  level = 0;
  totalStrokes = [];
  showHomeScreen();
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawHole();
  drawObstacles();
  drawSand();
  drawBall();
  drawLineAndPower();
  updateBall();
  checkHole();
  requestAnimationFrame(gameLoop);
}

// Controls
canvas.addEventListener("mousedown", (e) => {
  if (!ball.isMoving) {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    const dx = mx - ball.x;
    const dy = my - ball.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist <= ball.radius) {
      isDragging = true;
      dragStart = { x: mx, y: my };
      dragEnd = { x: mx, y: my };
    }
  }
});

canvas.addEventListener("mousemove", (e) => {
  if (isDragging) {
    const rect = canvas.getBoundingClientRect();
    dragEnd = { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }
});

canvas.addEventListener("mouseup", (e) => {
  if (isDragging) {
    const rect = canvas.getBoundingClientRect();
    const dx = dragStart.x - (e.clientX - rect.left);
    const dy = dragStart.y - (e.clientY - rect.top);
    ball.vx = dx * (powerScale / 3);
    ball.vy = dy * (powerScale / 3);
    ball.isMoving = true;
    strokes++;
    isDragging = false;
  }
});

// Touch Events - fixed for mobile drag support
canvas.addEventListener("touchstart", (e) => {
  e.preventDefault();
  if (!ball.isMoving) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const tx = touch.clientX - rect.left;
    const ty = touch.clientY - rect.top;
    const dx = tx - ball.x;
    const dy = ty - ball.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist <= ball.radius) {
      isDragging = true;
      dragStart = { x: tx, y: ty };
      dragEnd = { x: tx, y: ty };
    }
  }
}, { passive: false });

canvas.addEventListener("touchmove", (e) => {
  e.preventDefault();
  if (isDragging) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    dragEnd = { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
  }
}, { passive: false });

canvas.addEventListener("touchend", (e) => {
  e.preventDefault();
  if (isDragging) {
    const dx = dragStart.x - dragEnd.x;
    const dy = dragStart.y - dragEnd.y;
    ball.vx = dx * (powerScale / 3);
    ball.vy = dy * (powerScale / 3);
    ball.isMoving = true;
    strokes++;
    isDragging = false;
  }
}, { passive: false });

// Home Screen functions
function showHomeScreen() {
  canvas.style.display = "none";
  homeScreen.style.display = "block";
  updateHighScoreDisplay();
  courseNameText.textContent = courses[selectedCourse].name;
}

function startGame() {
  homeScreen.style.display = "none";
  canvas.style.display = "block";
  level = 0;
  totalStrokes = [];
  loadLevel(level);
  gameLoop();
}

// Button listeners
startBtn.addEventListener("click", () => {
  startGame();
});

courseSunshineBtn.addEventListener("click", () => {
  selectedCourse = "sunshine";
  courseNameText.textContent = courses[selectedCourse].name;
  updateHighScoreDisplay();
  updateBackground();
});

courseMoonlightBtn.addEventListener("click", () => {
  selectedCourse = "moonlight";
  courseNameText.textContent = courses[selectedCourse].name;
  updateHighScoreDisplay();
  updateBackground();
});

// Resize handling
window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  if (canvas.style.display !== "none") {
    loadLevel(level);
  }
});

// Initialize
showHomeScreen();
</script>

</body>
</html>

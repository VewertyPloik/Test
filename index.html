<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zombie Survival Showdown</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');
  body {
    margin: 0; background: #202020; color: white;
    font-family: 'Comic Neue', cursive, Arial, sans-serif;
    user-select: none; overflow: hidden;
  }
  #homeScreen, #gameScreen, #shopScreen, #gameOverScreen, #winScreen {
    position: absolute; top:0; left:0; right:0; bottom:0;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    background: #121212;
    z-index: 100;
  }
  #gameScreen, #shopScreen, #gameOverScreen, #winScreen {
    display: none;
  }
  h1 {
    font-size: 3.5rem; margin-bottom: 20px; text-shadow: 2px 2px #00cc00;
  }
  button {
    background: #00cc00; border: none; border-radius: 10px;
    font-size: 1.5rem; padding: 12px 30px; margin: 10px;
    color: #111; font-weight: bold; cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #00ee00;
  }
  #gameCanvas {
    background: #1a1a1a;
    border: 5px solid #00cc00; border-radius: 20px;
    display: block; margin: 20px auto;
    box-shadow: 0 0 15px #00cc00aa;
    touch-action: none;
  }
  #infoBar {
    display: flex; justify-content: space-around; align-items: center;
    margin-top: 5px; font-size: 1.3rem;
  }
  #healthBarContainer {
    width: 250px; height: 25px;
    border: 2px solid white; border-radius: 12px;
    overflow: hidden; background: #440000; margin-right: 10px;
    position: relative;
  }
  #healthBar {
    height: 100%; background: #00cc00; width: 100%;
    transition: width 0.3s;
  }
  #healthText {
    position: absolute; top: 0; left: 50%;
    transform: translateX(-50%);
    font-weight: bold; font-size: 1.1rem; color: white;
    user-select: none; pointer-events: none;
  }
  #coinsDisplay {
    font-weight: bold; color: #ffff55;
  }
  #waveDisplay {
    font-weight: bold; color: #00ffcc;
  }
  #zombieCount {
    font-weight: bold; color: #ff6666;
  }
  #shopItems {
    display: flex; justify-content: center; flex-wrap: wrap; margin-top: 10px;
  }
  .shopItem {
    background: #222; border: 2px solid #00cc00;
    border-radius: 10px; margin: 10px;
    padding: 10px 15px; width: 180px;
    cursor: pointer; color: white;
    user-select: none; transition: background 0.3s;
  }
  .shopItem:hover {
    background: #004400;
  }
  .shopItem.disabled {
    opacity: 0.5; cursor: not-allowed;
  }
  .shopItem h3 {
    margin: 5px 0; font-size: 1.3rem;
  }
  .shopItem p {
    margin: 3px 0; font-size: 1rem;
  }
  /* Invisible joystick full screen */
  #joystickArea {
    position: absolute; top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: 200;
    touch-action: none;
  }
  /* Attack button style */
  #attackBtn {
    position: absolute; bottom: 25px; right: 30px;
    font-size: 1.8rem; padding: 20px 30px;
    border-radius: 50px; background: #00cc00cc;
    border: none; color: #111; cursor: pointer;
    user-select: none; z-index: 300;
    transition: background 0.3s;
  }
  #attackBtn:hover {
    background: #00ee00cc;
  }
  /* Cheat code input */
  #cheatInput {
    margin-top: 15px;
    font-size: 1.2rem;
    padding: 5px 10px;
    border-radius: 6px;
    border: 2px solid #00cc00;
    background: #222;
    color: #0f0;
    width: 150px;
    text-align: center;
  }
  #cheatMsg {
    margin-top: 10px;
    font-size: 1rem;
    color: #ff5555;
  }
</style>
</head>
<body>

<!-- HOME SCREEN -->
<div id="homeScreen">
  <h1>Zombie Survival Showdown</h1>
  <button id="startBtn">Start Fighting</button>
  <p style="margin-top: 20px; font-size: 1.2rem;">Survive 25 waves of zombies! üßü‚Äç‚ôÇÔ∏èüßüüßü‚Äç‚ôÄÔ∏è</p>
  <input id="cheatInput" placeholder="Enter cheat code" maxlength="5" autocomplete="off" />
  <div id="cheatMsg"></div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" style="position: relative;">
  <canvas id="gameCanvas" width="800" height="450"></canvas>

  <!-- Invisible joystick -->
  <div id="joystickArea"></div>

  <!-- Attack button -->
  <button id="attackBtn">Attack üî™</button>

  <div id="infoBar">
    <div style="display:flex; align-items:center;">
      <div id="healthBarContainer">
        <div id="healthBar"></div>
        <div id="healthText">100 / 100</div>
      </div>
      <div>Health</div>
    </div>
    <div id="coinsDisplay">Coins: 0 üí∞</div>
    <div id="waveDisplay">Wave: 1/25</div>
    <div id="zombieCount">Zombies Left: 0</div>
  </div>
</div>

<!-- SHOP SCREEN -->
<div id="shopScreen">
  <h1>Shop - Upgrade Your Arsenal</h1>
  <div id="coinsDisplayShop" style="font-size:1.5rem; color: #ffff55;"></div>
  <div id="shopItems"></div>
  <button id="continueBtn" style="margin-top: 25px;">Continue to Next Wave</button>
</div>

<!-- GAME OVER SCREEN -->
<div id="gameOverScreen">
  <h1>Game Over</h1>
  <p id="gameOverText" style="font-size: 1.8rem; margin: 20px;"></p>
  <button id="restartBtn">Restart</button>
</div>

<!-- WIN SCREEN -->
<div id="winScreen">
  <h1>Congratulations!</h1>
  <p style="font-size: 1.8rem; margin: 20px;">You survived all 25 waves! üßü‚Äç‚ôÇÔ∏èüí•üôé‚Äç‚ôÇÔ∏è</p>
  <button id="winRestartBtn">Play Again</button>
</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  // DOM elements
  const homeScreen = document.getElementById('homeScreen');
  const gameScreen = document.getElementById('gameScreen');
  const shopScreen = document.getElementById('shopScreen');
  const gameOverScreen = document.getElementById('gameOverScreen');
  const winScreen = document.getElementById('winScreen');

  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const winRestartBtn = document.getElementById('winRestartBtn');
  const continueBtn = document.getElementById('continueBtn');

  const healthBar = document.getElementById('healthBar');
  const healthText = document.getElementById('healthText');
  const coinsDisplay = document.getElementById('coinsDisplay');
  const coinsDisplayShop = document.getElementById('coinsDisplayShop');
  const waveDisplay = document.getElementById('waveDisplay');
  const gameOverText = document.getElementById('gameOverText');
  const shopItemsContainer = document.getElementById('shopItems');
  const zombieCountDisplay = document.getElementById('zombieCount');

  const joystickArea = document.getElementById('joystickArea');
  const attackBtn = document.getElementById('attackBtn');

  const cheatInput = document.getElementById('cheatInput');
  const cheatMsg = document.getElementById('cheatMsg');

  // Sounds
  const sounds = {
    knife: new Audio('https://actions.google.com/sounds/v1/weapons/knife_stab.ogg'),
    pistol: new Audio('https://actions.google.com/sounds/v1/weapons/pistol_shot.ogg'),
    rifle: new Audio('https://actions.google.com/sounds/v1/weapons/automatic_rifle.ogg'),
    shotgun: new Audio('https://actions.google.com/sounds/v1/weapons/shotgun_fire.ogg'),
    rocket: new Audio('https://actions.google.com/sounds/v1/explosions/explosion_large.ogg'),
    hit: new Audio('https://actions.google.com/sounds/v1/human_voices/gasp.ogg'),
    zombieGrowl: new Audio('https://actions.google.com/sounds/v1/creatures/zombie_growl_1.ogg'),
    gameOver: new Audio('https://actions.google.com/sounds/v1/cartoon/slide_whistle_down.ogg'),
    win: new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'),
  };

  for(let s in sounds) sounds[s].volume = 0.15;

  // Constants & Variables
  const PLAYER_START_HEALTH = 100;
  const WAVE_TOTAL = 25;
  const SHOP_TIME = 10 * 1000;
  const ZOMBIE_DAMAGE = 0.5;
  const PLAYER_SPEED_MULTIPLIER = 2;
  const ZOMBIE_HIT_COOLDOWN = 1000; // ms

  const weapons = [
    { name: "Knife", cost: 0, damage: 10, emoji: "üî™", sfx: sounds.knife, desc: "Basic melee weapon, infinite uses", unlocked: true },
    { name: "Pistol", cost: 50, damage: 15, emoji: "üî´", sfx: sounds.pistol, desc: "Basic handgun, better range", unlocked: false },
    { name: "Rifle", cost: 250, damage: 25, emoji: "üî´üî´", sfx: sounds.rifle, desc: "Powerful automatic rifle", unlocked: false },
    { name: "Shotgun", cost: 500, damage: 50, emoji: "üî´üî´üî´", sfx: sounds.shotgun, desc: "Close range but heavy damage", unlocked: false },
    { name: "Rocket Launcher", cost: 1000, damage: 100, emoji: "üöÄ", sfx: sounds.rocket, desc: "Explodes up to 15 zombies at once", unlocked: false }
  ];

  const healItems = [
    { name: "Apple", cost: 25, healAmount: 25, emoji: "üçé", desc: "Restores 25 health" },
    { name: "Full Heal", cost: 100, healAmount: PLAYER_START_HEALTH, emoji: "üíä", desc: "Restores full health" }
  ];

  let player = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    width: 35,
    height: 50,
    health: PLAYER_START_HEALTH,
    coins: 0,
    weaponIndex: 0,
    speed: 1.4,
    isAttacking: false,
    attackCooldown: 0,
    facing: 'right',
  };

  let zombies = [];
  let wave = 0;
  let gameRunning = false;
  let inShop = false;
  let keysPressed = {};
  let lastAttackTime = 0;
  let rocketAmmo = 0;

  // For zombies cooldown on hitting player
  let lastZombieHitTimes = new Map();

  // Joystick vars
  let joystickActive = false;
  let joystickStartX = 0;
  let joystickStartY = 0;
  let joystickCurrentX = 0;
  let joystickCurrentY = 0;

  // Helpers
  function playSfx(sound) {
    if (!sound) return;
    sound.currentTime = 0;
    sound.play();
  }

  function rectCollide(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw &&
           ax + aw > bx &&
           ay < by + bh &&
           ah + ay > by;
  }

  function spawnZombies(waveNum) {
    zombies = [];
    const baseCount = Math.min(5 + waveNum * 2, 60);
    const baseHealth = 50;
    const baseSpeed = 0.7 + waveNum * 0.05;

    for(let i=0; i<baseCount; i++) {
      let side = Math.random() < 0.5 ? 'left' : 'right';
      zombies.push({
        id: i,
        x: side === 'left' ? -30 - Math.random() * 300 : canvas.width + 30 + Math.random() * 300,
        y: canvas.height - 70 - (Math.random() * 50),
        width: 40,
        height: 60,
        health: baseHealth,
        maxHealth: baseHealth,
        speed: baseSpeed + Math.random() * 0.4,
        side: side,
        emoji: ["üßü","üßü‚Äç‚ôÄÔ∏è","üßü‚Äç‚ôÇÔ∏è"][Math.floor(Math.random()*3)],
        alive: true,
      });
    }
  }

  function resetPlayer() {
    player.health = PLAYER_START_HEALTH;
    player.coins = 0;
    player.weaponIndex = 0;
    rocketAmmo = 0;
    player.x = canvas.width / 2;
    player.y = canvas.height / 2;
    player.isAttacking = false;
    player.attackCooldown = 0;
    player.facing = 'right';
    lastZombieHitTimes.clear();
  }

  function showScreen(screen) {
    [homeScreen, gameScreen, shopScreen, gameOverScreen, winScreen].forEach(s => {
      s.style.display = 'none';
    });
    screen.style.display = 'flex';
  }

  function drawPlayer() {
    ctx.font = '50px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText('üôé‚Äç‚ôÇÔ∏è', player.x, player.y + player.height);

    const weaponEmoji = weapons[player.weaponIndex].emoji;
    const offsetX = player.facing === 'right' ? 25 : -25;
    ctx.font = '32px Arial';
    ctx.fillText(weaponEmoji, player.x + offsetX, player.y + player.height - 20);
  }

  function drawZombies() {
    ctx.font = '45px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';

    zombies.forEach(z => {
      if (!z.alive) return;
      ctx.fillText(z.emoji, z.x, z.y + z.height);

      // health bar
      ctx.fillStyle = 'red';
      ctx.fillRect(z.x - 20, z.y + z.height - 65, 40, 5);
      ctx.fillStyle = 'lime';
      ctx.fillRect(z.x - 20, z.y + z.height - 65, 40 * (z.health / z.maxHealth), 5);
    });
  }

  function updateUI() {
    const healthPercent = Math.max(0, player.health) / PLAYER_START_HEALTH * 100;
    healthBar.style.width = healthPercent + '%';
    if(healthPercent > 60) {
      healthBar.style.background = '#00cc00';
    } else if (healthPercent > 30) {
      healthBar.style.background = '#ffcc00';
    } else {
      healthBar.style.background = '#cc0000';
    }
    healthText.textContent = `${Math.floor(player.health)} / ${PLAYER_START_HEALTH}`;
    coinsDisplay.textContent = `Coins: ${player.coins} üí∞`;
    coinsDisplayShop.textContent = `Coins: ${player.coins} üí∞`;
    waveDisplay.textContent = `Wave: ${wave} / ${WAVE_TOTAL}`;
    zombieCountDisplay.textContent = `Zombies Left: ${zombies.filter(z=>z.alive).length}`;
  }

  function movePlayer() {
    let speed = player.speed * PLAYER_SPEED_MULTIPLIER;
    let moveX = 0, moveY = 0;

    // Keyboard movement
    if(keysPressed['a'] || keysPressed['arrowleft']) moveX -= speed;
    if(keysPressed['d'] || keysPressed['arrowright']) moveX += speed;
    if(keysPressed['w'] || keysPressed['arrowup']) moveY -= speed;
    if(keysPressed['s'] || keysPressed['arrowdown']) moveY += speed;

    // Joystick movement (if active)
    if(joystickActive) {
      const dx = joystickCurrentX - joystickStartX;
      const dy = joystickCurrentY - joystickStartY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist > 10) {
        moveX += (dx / dist) * speed;
        moveY += (dy / dist) * speed;
      }
    }

    player.x += moveX;
    player.y += moveY;

    // Keep player inside canvas bounds
    if(player.x < 20) player.x = 20;
    if(player.x > canvas.width - 20) player.x = canvas.width - 20;
    if(player.y < 50) player.y = 50;
    if(player.y > canvas.height - 20) player.y = canvas.height - 20;

    if(moveX > 0) player.facing = 'right';
    else if(moveX < 0) player.facing = 'left';
  }

  function updateZombies() {
    zombies.forEach(z => {
      if (!z.alive) return;

      // Move toward player
      const dx = player.x - z.x;
      const dy = player.y - z.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist > 1) {
        z.x += (dx / dist) * z.speed;
        z.y += (dy / dist) * z.speed;
      }

      // Simple collision avoidance between zombies (repulsion)
      zombies.forEach(other => {
        if(other.id === z.id || !other.alive) return;
        const dx2 = other.x - z.x;
        const dy2 = other.y - z.y;
        const dist2 = Math.sqrt(dx2*dx2 + dy2*dy2);
        if(dist2 < 40 && dist2 > 0) {
          const repelX = -dx2 / dist2 * 0.4;
          const repelY = -dy2 / dist2 * 0.4;
          z.x += repelX;
          z.y += repelY;
          other.x -= repelX;
          other.y -= repelY;
        }
      });

      // Zombie hits player if close enough and cooldown passed
      if(dist < 50) {
        const now = Date.now();
        const lastHit = lastZombieHitTimes.get(z.id) || 0;
        if(now - lastHit > ZOMBIE_HIT_COOLDOWN) {
          player.health -= ZOMBIE_DAMAGE;
          playSfx(sounds.zombieGrowl);
          lastZombieHitTimes.set(z.id, now);
        }
      }

      // Keep zombies inside canvas vertically
      if(z.y > canvas.height - 20) z.y = canvas.height - 20;
      if(z.y < 40) z.y = 40;
    });
  }

  function attack() {
    if(Date.now() - lastAttackTime < 500) return; // cooldown 0.5s
    lastAttackTime = Date.now();

    const weapon = weapons[player.weaponIndex];
    let hit = false;

    // Calculate attack range box
    const attackRange = 60;
    let attackX = player.facing === 'right' ? player.x + attackRange : player.x - attackRange;
    let attackY = player.y + player.height / 2;

    // For rocket launcher, do area damage
    if(weapon.name === "Rocket Launcher" && rocketAmmo > 0) {
      rocketAmmo--;
      playSfx(weapon.sfx);
      let hitCount = 0;
      zombies.forEach(z => {
        if (!z.alive) return;
        const dx = z.x - player.x;
        const dy = z.y - player.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist <= 150) {
          z.health -= weapon.damage;
          hit = true;
          hitCount++;
          if(z.health <= 0) {
            z.alive = false;
            player.coins += 5;
          }
        }
      });
      if(hitCount > 0) {
        playSfx(sounds.hit);
      }
    } else {
      // Normal attack: check for zombies in front of player and close enough
      zombies.forEach(z => {
        if (!z.alive) return;
        const dx = z.x - attackX;
        const dy = z.y - attackY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < 40) {
          z.health -= weapon.damage;
          hit = true;
          playSfx(weapon.sfx);
          if(z.health <= 0) {
            z.alive = false;
            player.coins += 5;
          }
        }
      });
    }
    if(!hit) playSfx(sounds.hit); // play hit sound anyway for feedback
    updateUI();
  }

  function checkWaveEnd() {
    if(zombies.filter(z=>z.alive).length === 0) {
      if(wave >= WAVE_TOTAL) {
        // Player won
        gameRunning = false;
        showScreen(winScreen);
        playSfx(sounds.win);
      } else {
        inShop = true;
        showShop();
      }
    }
  }

  function showShop() {
    showScreen(shopScreen);
    updateUI();
    // Display weapons and heal items
    shopItemsContainer.innerHTML = '';
    weapons.forEach((w,i) => {
      if(i === 0 || weapons[i-1].unlocked) {
        // show all weapons that are unlocked or next in line
        const item = document.createElement('div');
        item.className = 'shopItem' + (w.unlocked ? '' : ' disabled');
        item.innerHTML = `
          <h3>${w.emoji} ${w.name}</h3>
          <p>${w.desc}</p>
          <p>Damage: ${w.damage}</p>
          <p>Cost: ${w.cost} üí∞</p>
        `;
        if(!w.unlocked && player.coins >= w.cost) {
          item.style.cursor = 'pointer';
          item.onclick = () => {
            if(player.coins >= w.cost && !w.unlocked) {
              player.coins -= w.cost;
              w.unlocked = true;
              player.weaponIndex = i;
              if(w.name === "Rocket Launcher") rocketAmmo = 3; // initial ammo
              updateUI();
              showShop();
            }
          };
        }
        shopItemsContainer.appendChild(item);
      }
    });
    healItems.forEach(h => {
      const item = document.createElement('div');
      item.className = (player.health >= PLAYER_START_HEALTH) ? 'shopItem disabled' : 'shopItem';
      item.innerHTML = `<h3>${h.emoji} ${h.name}</h3><p>${h.desc}</p><p>Cost: ${h.cost} üí∞</p>`;
      if(player.health < PLAYER_START_HEALTH && player.coins >= h.cost) {
        item.style.cursor = 'pointer';
        item.onclick = () => {
          if(player.coins >= h.cost) {
            player.coins -= h.cost;
            player.health += h.healAmount;
            if(player.health > PLAYER_START_HEALTH) player.health = PLAYER_START_HEALTH;
            updateUI();
            showShop();
          }
        };
      }
      shopItemsContainer.appendChild(item);
    });
  }

  function gameLoop() {
    if(!gameRunning) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    movePlayer();
    updateZombies();

    drawPlayer();
    drawZombies();

    updateUI();

    checkWaveEnd();

    if(player.health <= 0) {
      gameRunning = false;
      showScreen(gameOverScreen);
      gameOverText.textContent = `You survived until wave ${wave}.`;
      playSfx(sounds.gameOver);
    }

    requestAnimationFrame(gameLoop);
  }

  // Event listeners for keys
  window.addEventListener('keydown', e => {
    keysPressed[e.key.toLowerCase()] = true;
  });
  window.addEventListener('keyup', e => {
    keysPressed[e.key.toLowerCase()] = false;
  });

  // Joystick touch handling
  joystickArea.addEventListener('touchstart', e => {
    e.preventDefault();
    const t = e.touches[0];
    joystickActive = true;
    joystickStartX = t.clientX;
    joystickStartY = t.clientY;
    joystickCurrentX = joystickStartX;
    joystickCurrentY = joystickStartY;
  });
  joystickArea.addEventListener('touchmove', e => {
    e.preventDefault();
    if(!joystickActive) return;
    const t = e.touches[0];
    joystickCurrentX = t.clientX;
    joystickCurrentY = t.clientY;
  });
  joystickArea.addEventListener('touchend', e => {
    e.preventDefault();
    joystickActive = false;
  });

  // Attack button
  attackBtn.addEventListener('click', () => {
    if(gameRunning && !inShop) {
      attack();
    }
  });

  // Start button
  startBtn.addEventListener('click', () => {
    resetPlayer();
    wave = 1;
    spawnZombies(wave);
    showScreen(gameScreen);
    inShop = false;
    gameRunning = true;
    updateUI();
    gameLoop();
  });

  // Continue button from shop
  continueBtn.addEventListener('click', () => {
    wave++;
    spawnZombies(wave);
    showScreen(gameScreen);
    inShop = false;
    updateUI();
    gameRunning = true;
    gameLoop();
  });

  // Restart buttons
  restartBtn.addEventListener('click', () => {
    showScreen(homeScreen);
  });
  winRestartBtn.addEventListener('click', () => {
    showScreen(homeScreen);
  });

  // Cheat code input handler
  cheatInput.addEventListener('input', () => {
    const val = cheatInput.value.trim();
    cheatMsg.textContent = '';
    if(val === '77660') {
      player.coins += 100000;
      updateUI();
      cheatMsg.style.color = '#0f0';
      cheatMsg.textContent = 'Cheat code accepted! +100,000 coins';
      cheatInput.value = '';
    } else if(val.length === 5) {
      cheatMsg.style.color = '#f55';
      cheatMsg.textContent = 'Invalid cheat code!';
    }
  });

  // Start on home screen
  showScreen(homeScreen);

})();
</script>

</body>
</html>
